diff -Npur ffmpeg-5.1.2/libavcodec/rkmppdec.c ffmpeg-5.1.2-change/libavcodec/rkmppdec.c
--- ffmpeg-5.1.2/libavcodec/rkmppdec.c	2022-07-23 01:58:39.000000000 +0800
+++ ffmpeg-5.1.2-change/libavcodec/rkmppdec.c	2024-12-14 16:30:06.449865343 +0800
@@ -460,8 +460,8 @@ static int rkmpp_retrieve_frame(AVCodecC
 
             frame->hw_frames_ctx = av_buffer_ref(decoder->frames_ref);
             if (!frame->hw_frames_ctx) {
-                ret = AVERROR(ENOMEM);
-                goto fail;
+		av_frame_unref(frame);
+		return AVERROR(ENOMEM);
             }
 
             return 0;
