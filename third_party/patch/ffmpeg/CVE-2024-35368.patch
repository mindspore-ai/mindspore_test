diff -Npur ffmpeg-5.1.4/libavcodec/rkmppdec.c ffmpeg-5.1.4-change/libavcodec/rkmppdec.c
--- ffmpeg-5.1.4/libavcodec/rkmppdec.c	2023-11-10 07:38:51.000000000 +0800
+++ ffmpeg-5.1.4-change/libavcodec/rkmppdec.c	2024-12-09 12:03:21.558913872 +0800
@@ -460,8 +460,8 @@ static int rkmpp_retrieve_frame(AVCodecC
 
             frame->hw_frames_ctx = av_buffer_ref(decoder->frames_ref);
             if (!frame->hw_frames_ctx) {
-                ret = AVERROR(ENOMEM);
-                goto fail;
+                av_frame_unref(frame);
+                return AVERROR(ENOMEM);
             }
 
             return 0;
